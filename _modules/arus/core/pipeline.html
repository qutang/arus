<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>arus.core.pipeline &#8212; arus 0.6.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          arus</a>
        <span class="navbar-text navbar-version pull-left"><b>0.6.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../examples/index.html">Examples</a></li>
                <li><a href="../../../references.html">References</a></li>
                <li><a href="../../../news.html">Changelog</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">arus <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for arus.core.pipeline</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module includes classes that accept single or multiple `arus.core.stream` instances, synchronize data from the streams, process the data using customized processor function, and output using the same iterator interface as `arus.core.stream`.</span>

<span class="sd"># Usage of `arus.core.pipeline.Pipeline`</span>

<span class="sd"># Single stream case</span>

<span class="sd">```python</span>
<span class="sd">.. include:: ../../examples/single_stream_pipeline.py</span>
<span class="sd">```</span>

<span class="sd"># Multiple streams case</span>

<span class="sd">```python</span>
<span class="sd">.. include:: ../../examples/multi_stream_pipeline.py</span>
<span class="sd">```</span>

<span class="sd">Author: Qu Tang</span>

<span class="sd">Date: 2019-11-15</span>

<span class="sd">License: see LICENSE file</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">.libs</span> <span class="kn">import</span> <span class="n">date</span> <span class="k">as</span> <span class="n">arus_date</span>
<span class="kn">import</span> <span class="nn">pathos.pools</span> <span class="k">as</span> <span class="nn">ppools</span>
<span class="kn">import</span> <span class="nn">pathos.helpers</span> <span class="k">as</span> <span class="nn">phelpers</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>


<div class="viewcode-block" id="Pipeline"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.html#arus.core.pipeline.Pipeline">[docs]</a><span class="k">class</span> <span class="nc">Pipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The base class for a pipeline</span>

<span class="sd">    Pipeline class is a base class of any processor that accepts multiple `arus.core.stream` instances, sync and process them, and output the processed results.</span>

<span class="sd">    The base class provides the functionality to add, and sync multiple streams, as well as the functionality to add customized processor functions.</span>

<span class="sd">    Subclass may implement more complex logic such as saving the status of the processed results internally and reuse them with new data from the stream.</span>

<span class="sd">    Implementation details:</span>
<span class="sd">        Streams are served in threads. Data windows coming from the streams will be synced on a separate thread at first and the synced and merged data windows will be sent to process pools as process tasks for CPU intensive processing asynchronizedly. Another separate thread will wait for the completion of the process tasks and send the result to the result queue.</span>

<span class="sd">        This implementation, compared with previous version, makes the data processing most flexible considering that some processing needs to use data from more than one stream. Moreover, the customized process task can spawn other sub processes to further parallize the computational tasks for different combinations of stream data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pipeline (Pipeline): an instance object of type `Pipeline`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;processes&#39;</span><span class="p">,</span> <span class="n">preserve_status</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default-pipeline&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            max_processes (int, optional): the max number of sub processes to be spawned. Defaults to &#39;None&#39;. If it is `None`, the max processes will be the number of cores - 2.</span>
<span class="sd">            scheduler (str, optional): scheduler to use, either &#39;processes&#39; or &#39;threads&#39;. Defaults to &#39;processes&#39;.</span>
<span class="sd">            preserve_status (bool, optional): whether to preserve the previous input and output in the processor. If `True`, the second and third argument of processor function would be `prev_input` and `prev_output`. Defaults to `False`. When it is `True`, processors will run in sequence, meaning the next processor will start only when the previous one has completed.</span>
<span class="sd">            name (str, optional): the name of the pipeline. It will also be used as a prefix for all threads spawned by the class. Defaults to &#39;default-pipeline&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="n">scheduler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_processes</span> <span class="o">=</span> <span class="n">max_processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prev_input</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prev_output</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_pointer</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_sender</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preserve_status</span> <span class="o">=</span> <span class="n">preserve_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;`name` property getter</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: the name of the pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;`name` property setter</span>

<span class="sd">        Args:</span>
<span class="sd">            value (str): the name of the pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">started</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The status of the pipeline. Getter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: the status of the pipeline. &#39;True&#39; means the pipeline is running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span>

    <span class="nd">@started</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">started</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The status of the pipeline. Setter.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (bool): the status of the pipeline. &#39;True&#39; means the pipeline is running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Pipeline.stop"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.stop.html#arus.core.pipeline.Pipeline.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish_tasks_and_stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="Pipeline.finish_tasks_and_stop"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.finish_tasks_and_stop.html#arus.core.pipeline.Pipeline.finish_tasks_and_stop">[docs]</a>    <span class="k">def</span> <span class="nf">finish_tasks_and_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gracefully shutdown the pipeline using the following procedure.</span>

<span class="sd">        1. It stops accepting incoming stream data.</span>
<span class="sd">        2. It allows sub-processes to finish existing tasks.</span>
<span class="sd">        3. It stops the sender thread.</span>
<span class="sd">        4. It stops the sub process pool to accept new tasks.</span>
<span class="sd">        5. It stops all incoming streams.</span>
<span class="sd">        6. It terminates the sub process pool.</span>

<span class="sd">        If any exceptions occur during the process, the function will return `False`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: `True` if the pipeline is shut down correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stop pipeline...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Wait for processing tasks...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_sender</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Close processing pool...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stop input streams...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clear result queue...&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopped.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Pipeline.pause"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.pause.html#arus.core.pipeline.Pipeline.pause">[docs]</a>    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pause processing the incoming streams, yet pipeline can still receive data from streams. Data will be ignored and not stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;It is not allowed to modify streams while pipeline is running, please stop the pipeline at first&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Pipeline.get_stream"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.get_stream.html#arus.core.pipeline.Pipeline.get_stream">[docs]</a>    <span class="k">def</span> <span class="nf">get_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the stream instance by its name</span>

<span class="sd">        Args:</span>
<span class="sd">            stream_name (str): The name of the stream</span>

<span class="sd">        Returns:</span>
<span class="sd">            arus.core.Stream: The instance of the stream if it is found, otherwise return `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">stream_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Pipeline.add_stream"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.add_stream.html#arus.core.pipeline.Pipeline.add_stream">[docs]</a>    <span class="k">def</span> <span class="nf">add_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new stream to the pipeline</span>

<span class="sd">        The stream will only be added when the pipeline is stopped.</span>

<span class="sd">        Args:</span>
<span class="sd">            stream (arus.core.Stream): an instance of arus.core.Stream class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.set_processor"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.set_processor.html#arus.core.pipeline.Pipeline.set_processor">[docs]</a>    <span class="k">def</span> <span class="nf">set_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the processor function and its arguments</span>

<span class="sd">        The processor function should accept the following arg in the first place:</span>
<span class="sd">            chunk_list (list): A list of tuple including chunked data (one window) from all streams. Each tuple includes the following items.</span>
<span class="sd">            1. data: the chunked data of the stream</span>
<span class="sd">            2. name: the name of the stream</span>

<span class="sd">        Args:</span>
<span class="sd">            processor (object): A function to process chunks from the streams.</span>
<span class="sd">            kwargs (dict): keyword arguments passed to processor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processor</span> <span class="o">=</span> <span class="n">processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processor_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="Pipeline.remove_stream"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.remove_stream.html#arus.core.pipeline.Pipeline.remove_stream">[docs]</a>    <span class="k">def</span> <span class="nf">remove_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove stream from the pipeline</span>

<span class="sd">        Remove only works when the pipeline is stopped.</span>

<span class="sd">        Args:</span>
<span class="sd">            stream_name (str): The name of the stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">found_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stream</span><span class="p">(</span><span class="n">stream_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">found_stream</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_sync_streams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementation details:</span>
<span class="sd">            This method depends on the stream to make sure it will not block for a long time when providing the chunk.</span>

<span class="sd">            This method also asssumes that when one window of data is missing, the stream should provide a notification, such as `None` for that window.</span>

<span class="sd">            Therefore, in the case when a Bluetooth device disconnects, the stream that serves the data of the device should always output `None` or empty DataFrame for those windows.</span>

<span class="sd">            In real time, because stream runs on separate thread, as long as the data is successfully passed to the stream queue, it won&#39;t block for a long time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_of_processors</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">phelpers</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_processes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_of_processors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">==</span> <span class="s1">&#39;processes&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="n">ppools</span><span class="o">.</span><span class="n">ProcessPool</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">num_of_processors</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">==</span> <span class="s1">&#39;threads&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="n">ppools</span><span class="o">.</span><span class="n">ThreadPool</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">num_of_processors</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s1">&#39;This scheduler is not supported: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_iterator</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_data_after_start_time</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;recieved data window from &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span>
                            <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_stream_pointer</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_data_after_start_time</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_process_synced_chunks</span><span class="p">(</span>
                            <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Discard one stream window&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="n">st</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;coming before process start time: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="p">:</span>
                    <span class="c1"># ignore the incoming stream data, the thread will stand by</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_send_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_sender</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">task</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_processes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">task</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preserve_status</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prev_output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sending processed results to queue...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_put_result_in_queue</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="p">:</span>
                    <span class="c1"># ignore if the pipeline is just connected but not started</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_synced_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">chunk_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">):</span>
            <span class="c1"># this is the last stream chunk for st</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preserve_status</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prev_st</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># the first window</span>
                    <span class="n">prev_input</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">prev_output</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prev_input</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">prev_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prev_output</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_processes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processor</span><span class="p">(</span>
                        <span class="n">chunk_list</span><span class="p">,</span> <span class="n">prev_input</span><span class="p">,</span> <span class="n">prev_output</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_processor_kwargs</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">apipe</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_processor</span><span class="p">,</span> <span class="n">chunk_list</span><span class="p">,</span> <span class="n">prev_input</span><span class="p">,</span> <span class="n">prev_output</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_processor_kwargs</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preserve_status</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prev_input</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_processes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processor</span><span class="p">(</span>
                        <span class="n">chunk_list</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_processor_kwargs</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting a processing task...&#39;</span><span class="p">)</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">apipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processor</span><span class="p">,</span> <span class="n">chunk_list</span><span class="p">,</span>
                                                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_processor_kwargs</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started a processing task...&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_process_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">prev_st</span><span class="p">,</span> <span class="n">prev_et</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_put_result_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_data_after_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Pipeline.connect"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.connect.html#arus.core.pipeline.Pipeline.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect and start the streams but not processing them.</span>

<span class="sd">        This function will start the streams one by one on daemon threads, and will start the syncing thread and sender thread as daemons in stand-by status.</span>

<span class="sd">        The streams will output data but data will be ignored by the pipeline until `Pipeline.process` got called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_sender</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_streams</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s1">&#39;-sync-streams&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sender_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_result</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s1">&#39;-send-result&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sender_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sender_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Pipeline.process"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.process.html#arus.core.pipeline.Pipeline.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start processing the connected incoming stream data.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_time (str or datetime or np.datetime64 or pd.Timestamp, optional): The start time to start accepting the incoming stream windows. If it is `None`, the pipeline will always output any incoming data without checking `start_time`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span> <span class="o">=</span> <span class="n">arus_date</span><span class="o">.</span><span class="n">parse_timestamp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_start_time</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_cond</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Pipeline.start"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.start.html#arus.core.pipeline.Pipeline.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">process_start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect and process the incoming streams in a row together.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_time (str or datetime or np.datetime64 or pd.Timestamp, optional): When multiple streams are provided, users must provide a valid start_time as a reference to sync between streams. If it is `None`, it will use the first timestamp from the stream data as start_time. Default is None. </span>
<span class="sd">            process_start_time (str or datetime or np.datetime64 or pd.Timestamp, optional): Any stream windows coming before this time will be ignored. If it is `None`, nothing will be ignored. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="n">process_start_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pipeline.get_iterator"><a class="viewcode-back" href="../../../generated/arus.core.pipeline.Pipeline.get_iterator.html#arus.core.pipeline.Pipeline.get_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">get_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator for the processed results</span>

<span class="sd">        Raises:</span>
<span class="sd">            StopIteration: Raised when iterator ends</span>

<span class="sd">        Returns:</span>
<span class="sd">            Iteratable: an instance of a python iteratable for processed results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span>

        <span class="k">class</span> <span class="nc">_result_iterator</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># end of the stream, stop</span>
                        <span class="k">raise</span> <span class="ne">StopIteration</span>
                    <span class="k">return</span> <span class="n">data</span>
                <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">_result_iterator</span><span class="p">()</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2019, Qu Tang.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>