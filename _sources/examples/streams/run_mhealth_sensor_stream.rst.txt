.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_examples_streams_run_mhealth_sensor_stream.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_streams_run_mhealth_sensor_stream.py:


Stream using mhealth sensor files
================================================================================

This example demonstrates a stream that uses data files stored in mhealth specification as data source.

Imports
--------


.. code-block:: default

    import logging
    import os
    from glob import glob

    import matplotlib.pyplot as plt
    import numpy as np
    import pandas as pd

    from arus.core.stream import SensorFileSlidingWindowStream
    from arus.testing import load_test_data








Turn on logging information
---------------------------


.. code-block:: default

    logging.basicConfig(
        level=logging.DEBUG, format='[%(levelname)s]%(asctime)s <P%(process)d-%(threadName)s> %(message)s')








Get the test mhealth data files
-------------------------------


.. code-block:: default


    files, sr = load_test_data(file_type='mhealth',
                               file_num='multiple', exception_type='inconsistent_sr')








Setup stream
--------------


.. code-block:: default

    window_size = 12.8
    stream = SensorFileSlidingWindowStream(data_source=files,
                                           window_size=window_size,
                                           sr=sr,
                                           buffer_size=900,
                                           storage_format='mhealth',
                                           name='spades_2')








Start stream and read in data
-----------------------------


.. code-block:: default

    stream.start()
    chunk_sizes = []
    for data, _, _, _, _, name in stream.get_iterator():
        print("{},{},{}".format(
            data.iloc[0, 0], data.iloc[-1, 0], data.shape[0]))
        chunk_sizes.append(data.shape[0])





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    2018-06-14 12:00:00.007000,2018-06-14 12:00:12.787000,640
    2018-06-14 12:00:12.807000,2018-06-14 12:00:25.587000,640
    2018-06-14 12:00:25.607000,2018-06-14 12:00:38.387000,640
    2018-06-14 12:00:38.407000,2018-06-14 12:00:51.187000,640
    2018-06-14 12:00:51.207000,2018-06-14 12:01:03.987000,640
    2018-06-14 12:01:04.007000,2018-06-14 12:01:16.788000,640
    2018-06-14 12:01:16.807000,2018-06-14 12:01:29.587000,640
    2018-06-14 12:01:29.607000,2018-06-14 12:01:42.386000,640
    2018-06-14 12:01:42.407000,2018-06-14 12:01:55.187000,640
    2018-06-14 12:01:55.207000,2018-06-14 12:02:07.987000,640
    2018-06-14 12:02:08.007000,2018-06-14 12:02:20.786000,640
    2018-06-14 12:02:20.807000,2018-06-14 12:02:33.587000,640
    2018-06-14 12:02:33.607000,2018-06-14 12:02:46.387000,640
    2018-06-14 12:02:46.407000,2018-06-14 12:02:59.187000,640
    2018-06-14 12:02:59.207000,2018-06-14 12:03:11.067000,594
    2018-06-14 12:03:15.811000,2018-06-14 12:03:24.792000,450
    2018-06-14 12:03:24.812000,2018-06-14 12:03:37.592000,640
    2018-06-14 12:03:37.611000,2018-06-14 12:03:50.391000,640
    2018-06-14 12:03:50.411000,2018-06-14 12:04:03.191000,640
    2018-06-14 12:04:03.211000,2018-06-14 12:04:15.992000,640
    2018-06-14 12:04:16.011000,2018-06-14 12:04:28.791000,640
    2018-06-14 12:04:28.811000,2018-06-14 12:04:41.591000,640
    2018-06-14 12:04:41.612000,2018-06-14 12:04:54.392000,640
    2018-06-14 12:04:54.412000,2018-06-14 12:05:07.191000,640
    2018-06-14 12:05:07.212000,2018-06-14 12:05:19.992000,640
    2018-06-14 12:05:20.012000,2018-06-14 12:05:32.792000,640
    2018-06-14 12:05:32.812000,2018-06-14 12:05:45.592000,640
    2018-06-14 12:05:45.611000,2018-06-14 12:05:58.392000,640
    2018-06-14 12:05:58.411000,2018-06-14 12:06:11.192000,640
    2018-06-14 12:06:11.214000,2018-06-14 12:06:23.991000,640
    2018-06-14 12:06:24.012000,2018-06-14 12:06:36.792000,640
    2018-06-14 12:06:36.812000,2018-06-14 12:06:49.592000,640
    2018-06-14 12:06:49.612000,2018-06-14 12:07:02.392000,640
    2018-06-14 12:07:02.411000,2018-06-14 12:07:15.192000,640
    2018-06-14 12:07:15.212000,2018-06-14 12:07:27.992000,640
    2018-06-14 12:07:28.014000,2018-06-14 12:07:40.791000,640
    2018-06-14 12:07:40.812000,2018-06-14 12:07:53.591000,640
    2018-06-14 12:07:53.612000,2018-06-14 12:08:06.391000,640
    2018-06-14 12:08:06.411000,2018-06-14 12:08:19.192000,640
    2018-06-14 12:08:19.212000,2018-06-14 12:08:31.991000,640
    2018-06-14 12:08:32.012000,2018-06-14 12:08:44.792000,640
    2018-06-14 12:08:44.812000,2018-06-14 12:08:57.592000,640
    2018-06-14 12:08:57.611000,2018-06-14 12:09:10.392000,640
    2018-06-14 12:09:10.412000,2018-06-14 12:09:23.192000,640
    2018-06-14 12:09:23.211000,2018-06-14 12:09:35.991000,640
    2018-06-14 12:09:36.011000,2018-06-14 12:09:48.791000,640
    2018-06-14 12:09:48.812000,2018-06-14 12:10:01.591000,640
    2018-06-14 12:10:01.611000,2018-06-14 12:10:14.391000,640
    2018-06-14 12:10:14.412000,2018-06-14 12:10:27.191000,640
    2018-06-14 12:10:27.212000,2018-06-14 12:10:39.992000,640
    2018-06-14 12:10:40.011000,2018-06-14 12:10:52.791000,640
    2018-06-14 12:10:52.812000,2018-06-14 12:11:05.592000,640
    2018-06-14 12:11:05.612000,2018-06-14 12:11:18.391000,640
    2018-06-14 12:11:18.411000,2018-06-14 12:11:31.192000,640
    2018-06-14 12:11:31.212000,2018-06-14 12:11:43.991000,640
    2018-06-14 12:11:44.011000,2018-06-14 12:11:56.792000,640
    2018-06-14 12:11:56.811000,2018-06-14 12:12:09.592000,640
    2018-06-14 12:12:09.611000,2018-06-14 12:12:22.392000,640
    2018-06-14 12:12:22.412000,2018-06-14 12:12:35.192000,640
    2018-06-14 12:12:35.211000,2018-06-14 12:12:47.991000,640
    2018-06-14 12:12:48.011000,2018-06-14 12:13:00.791000,640
    2018-06-14 12:13:00.812000,2018-06-14 12:13:13.592000,640
    2018-06-14 12:13:13.612000,2018-06-14 12:13:26.391000,640
    2018-06-14 12:13:26.412000,2018-06-14 12:13:39.191000,640
    2018-06-14 12:13:39.211000,2018-06-14 12:13:51.991000,640
    2018-06-14 12:13:52.011000,2018-06-14 12:14:04.791000,640
    2018-06-14 12:14:04.811000,2018-06-14 12:14:17.591000,640
    2018-06-14 12:14:17.612000,2018-06-14 12:14:30.392000,640
    2018-06-14 12:14:30.411000,2018-06-14 12:14:43.191000,640
    2018-06-14 12:14:43.211000,2018-06-14 12:14:55.991000,640
    2018-06-14 12:14:56.011000,2018-06-14 12:15:08.791000,640
    2018-06-14 12:15:08.811000,2018-06-14 12:15:21.591000,640
    2018-06-14 12:15:21.611000,2018-06-14 12:15:34.391000,640
    2018-06-14 12:15:34.412000,2018-06-14 12:15:47.192000,640
    2018-06-14 12:15:47.212000,2018-06-14 12:15:59.991000,640
    2018-06-14 12:16:00.011000,2018-06-14 12:16:12.791000,640
    2018-06-14 12:16:12.812000,2018-06-14 12:16:25.591000,640
    2018-06-14 12:16:25.611000,2018-06-14 12:16:38.392000,640
    2018-06-14 12:16:38.411000,2018-06-14 12:16:51.191000,640
    2018-06-14 12:16:51.211000,2018-06-14 12:17:03.991000,243
    2018-06-14 12:17:04.011000,2018-06-14 12:17:16.791000,640
    2018-06-14 12:17:16.812000,2018-06-14 12:17:29.591000,640
    2018-06-14 12:17:29.612000,2018-06-14 12:17:42.391000,640
    2018-06-14 12:17:42.411000,2018-06-14 12:17:55.191000,640
    2018-06-14 12:17:55.211000,2018-06-14 12:18:07.991000,640
    2018-06-14 12:18:08.012000,2018-06-14 12:18:20.792000,640
    2018-06-14 12:18:20.811000,2018-06-14 12:18:33.592000,640
    2018-06-14 12:18:33.611000,2018-06-14 12:18:46.391000,640
    2018-06-14 12:18:46.412000,2018-06-14 12:18:59.192000,640
    2018-06-14 12:18:59.211000,2018-06-14 12:19:11.992000,640
    2018-06-14 12:19:12.012000,2018-06-14 12:19:24.791000,640
    2018-06-14 12:19:24.812000,2018-06-14 12:19:37.592000,640
    2018-06-14 12:19:37.611000,2018-06-14 12:19:50.392000,640
    2018-06-14 12:19:50.411000,2018-06-14 12:20:03.191000,640
    2018-06-14 12:20:03.212000,2018-06-14 12:20:15.992000,640
    2018-06-14 12:20:16.011000,2018-06-14 12:20:28.792000,640
    2018-06-14 12:20:28.812000,2018-06-14 12:20:41.591000,640
    2018-06-14 12:20:41.612000,2018-06-14 12:20:54.391000,640
    2018-06-14 12:20:54.412000,2018-06-14 12:21:07.192000,640
    2018-06-14 12:21:07.211000,2018-06-14 12:21:19.991000,640
    2018-06-14 12:21:20.011000,2018-06-14 12:21:32.791000,640
    2018-06-14 12:21:32.811000,2018-06-14 12:21:45.591000,640
    2018-06-14 12:21:45.611000,2018-06-14 12:21:58.391000,640
    2018-06-14 12:21:58.412000,2018-06-14 12:22:11.191000,640
    2018-06-14 12:22:11.211000,2018-06-14 12:22:23.991000,640
    2018-06-14 12:22:24.011000,2018-06-14 12:22:36.791000,640
    2018-06-14 12:22:36.811000,2018-06-14 12:22:49.591000,640
    2018-06-14 12:22:49.611000,2018-06-14 12:23:02.391000,640
    2018-06-14 12:23:02.411000,2018-06-14 12:23:15.191000,640
    2018-06-14 12:23:15.212000,2018-06-14 12:23:27.991000,640
    2018-06-14 12:23:28.012000,2018-06-14 12:23:40.791000,640
    2018-06-14 12:23:40.811000,2018-06-14 12:23:53.591000,640
    2018-06-14 12:23:53.611000,2018-06-14 12:24:06.392000,640
    2018-06-14 12:24:06.412000,2018-06-14 12:24:19.191000,640
    2018-06-14 12:24:19.212000,2018-06-14 12:24:31.991000,640
    2018-06-14 12:24:32.012000,2018-06-14 12:24:44.791000,640
    2018-06-14 12:24:44.812000,2018-06-14 12:24:57.591000,640
    2018-06-14 12:24:57.612000,2018-06-14 12:25:10.391000,640
    2018-06-14 12:25:10.411000,2018-06-14 12:25:23.192000,640
    2018-06-14 12:25:23.212000,2018-06-14 12:25:35.992000,640
    2018-06-14 12:25:36.011000,2018-06-14 12:25:48.791000,640
    2018-06-14 12:25:48.812000,2018-06-14 12:26:01.591000,640
    2018-06-14 12:26:01.611000,2018-06-14 12:26:14.392000,640
    2018-06-14 12:26:14.411000,2018-06-14 12:26:27.191000,640
    2018-06-14 12:26:27.212000,2018-06-14 12:26:39.991000,640




Stop stream
------------


.. code-block:: default

    stream.stop()








Plot the stats of the received data
------------------------------------

The plot shows there are two places where the sampling rate of the data drops. This is because the data files loaded have missing data at those moments. The test data is manipulated to include missing moments for test purpose.


.. code-block:: default

    pd.Series(chunk_sizes).plot(
        title='chunk sizes of the given stream with \nwindow size of ' + str(window_size) + ' seconds, sampling rate at ' + str(sr) + ' Hz')
    fig = plt.hlines(y=sr * window_size,
                     xmin=0,
                     xmax=len(chunk_sizes),
                     linestyles='dashed')



.. image:: /examples/streams/images/sphx_glr_run_mhealth_sensor_stream_001.png
    :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  0.998 seconds)


.. _sphx_glr_download_examples_streams_run_mhealth_sensor_stream.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: run_mhealth_sensor_stream.py <run_mhealth_sensor_stream.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: run_mhealth_sensor_stream.ipynb <run_mhealth_sensor_stream.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
